<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PS批处理工具</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
    .header { background: #fff; border-bottom: 1px solid #e0e0e0; padding: 0 20px; }
    .nav { display: flex; align-items: center; justify-content: space-between; height: 60px; }
    .logo { font-size: 18px; font-weight: 600; color: #333; }
    .nav-actions { display: flex; gap: 10px; }
    .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; transition: all 0.2s; }
    .btn.primary { background: #007AFF; color: white; }
    .btn.primary:hover { background: #0056CC; }
    .btn.secondary { background: #f0f0f0; color: #333; }
    .btn.secondary:hover { background: #e0e0e0; }
    .btn.success { background: #28a745; color: white; }
    .btn.success:hover { background: #218838; }
    .content { padding: 20px; max-width: 1200px; margin: 0 auto; }
    .panel { background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .panel h2 { margin-bottom: 15px; color: #333; font-size: 16px; }
    .row { display: flex; gap: 20px; margin-bottom: 15px; }
    .row > div { flex: 1; }
    .input-group { display: flex; gap: 8px; align-items: center; }
    .input-group input { flex: 1; }
    label { display: block; margin-bottom: 5px; font-weight: 500; color: #555; }
    input[type="text"] { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
    input[type="text"]:focus { outline: none; border-color: #007AFF; }
    .status { padding: 10px; background: #f8f9fa; border-radius: 4px; margin-bottom: 10px; font-weight: 500; }
    .log { background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 4px; font-family: 'Monaco', 'Menlo', monospace; font-size: 12px; height: 300px; overflow-y: auto; white-space: pre-wrap; }
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; display: flex; align-items: center; justify-content: center; }
    .modal[aria-hidden="true"] { display: none; }
    .modal-backdrop { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
    .modal-content { background: white; border-radius: 8px; padding: 0; width: 90%; max-width: 600px; position: relative; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid #e0e0e0; }
    .modal-title { font-size: 18px; font-weight: 600; }
    .modal-body { padding: 20px; }
    .browse-btn { padding: 6px 12px; font-size: 12px; white-space: nowrap; }
  </style>
</head>
<body>
  <header class="header">
    <div class="nav">
      <div class="logo">PS批处理工具</div>
      <nav class="nav-actions">
        <button class="btn secondary" onclick="openSettings()">设置</button>
        <button class="btn success" onclick="run()">开始处理</button>
      </nav>
    </div>
  </header>

  <!-- 主内容 -->
  <main class="content">
    <section class="panel">
      <h2>输入目录</h2>
      <div class="row">
        <div>
          <label>输入目录</label>
          <div class="input-group">
            <input id="inputDir" type="text" placeholder="选择包含图片文件的目录" />
            <button class="btn secondary browse-btn" onclick="selectInputDir()">浏览</button>
          </div>
        </div>
      </div>
    </section>
    <section class="panel">
      <h2>处理进度与日志</h2>
      <div id="status" class="status">就绪</div>
      <div id="log" class="log"></div>
    </section>
  </main>

  <!-- 设置弹窗（右上角入口） -->
  <div id="settingsModal" class="modal" aria-hidden="true">
    <div class="modal-backdrop" onclick="closeSettings()"></div>
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">运行配置</div>
        <button class="btn secondary" onclick="closeSettings()">完成</button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div>
            <label>Photoshop.exe 路径</label>
            <div class="input-group">
              <input id="photoshopPath" type="text" placeholder="选择Photoshop.exe文件" />
              <button class="btn secondary browse-btn" onclick="selectPhotoshopPath()">浏览</button>
            </div>
          </div>
        </div>
        <div class="row">
          <div>
            <label>JSX 脚本路径</label>
            <div class="input-group">
              <input id="jsxPath" type="text" placeholder="选择包含JSX脚本的文件夹" />
              <button class="btn secondary browse-btn" onclick="selectJsxPath()">浏览</button>
            </div>
          </div>
        </div>
        <div class="row">
          <div>
            <label>输出目录</label>
            <div class="input-group">
              <input id="outputDir" type="text" placeholder="选择输出目录" />
              <button class="btn secondary browse-btn" onclick="selectOutputDir()">浏览</button>
            </div>
          </div>
        </div>
        <div class="row">
          <div>
            <label>规则 JSON（可选）</label>
            <div class="input-group">
              <input id="rulesJsonPath" type="text" placeholder="选择规则JSON文件（可选）" />
              <button class="btn secondary browse-btn" onclick="selectRulesJsonPath()">浏览</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const $id = (x) => document.getElementById(x);
    let isRunning = false;

    document.addEventListener('DOMContentLoaded', () => {
      loadConfig();
      bindAutoSave();
      setupLogListener();
    });

    // 加载配置
    async function loadConfig() {
      try {
        const config = await window.electronAPI.getConfig();
        ['photoshopPath', 'jsxPath', 'inputDir', 'outputDir', 'rulesJsonPath'].forEach(k => {
          if (config[k]) {
            const el = $id(k);
            if (el) el.value = config[k];
          }
        });
        setStatus('配置已加载');
      } catch (error) {
        log(`加载配置失败: ${error.message}`);
      }
    }

    // 收集表单数据
    function collectConfig() {
      return {
        photoshopPath: ($id('photoshopPath').value || '').trim(),
        jsxPath: ($id('jsxPath').value || '').trim(),
        inputDir: ($id('inputDir').value || '').trim(),
        outputDir: ($id('outputDir').value || '').trim(),
        rulesJsonPath: ($id('rulesJsonPath').value || '').trim()
      };
    }

    // 保存配置
    async function saveConfig() {
      try {
        const config = collectConfig();
        await window.electronAPI.saveConfig(config);
      } catch (error) {
        log(`保存配置失败: ${error.message}`);
      }
    }

    // 文件/文件夹选择函数
    async function selectInputDir() {
      try {
        const path = await window.electronAPI.selectDirectory();
        if (path) {
          $id('inputDir').value = path;
          await saveConfig();
        }
      } catch (error) {
        log(`选择输入目录失败: ${error.message}`);
      }
    }

    async function selectPhotoshopPath() {
      try {
        const path = await window.electronAPI.selectFile({
          filters: [
            { name: 'Photoshop', extensions: ['exe'] },
            { name: '所有文件', extensions: ['*'] }
          ]
        });
        if (path) {
          $id('photoshopPath').value = path;
          await saveConfig();
        }
      } catch (error) {
        log(`选择Photoshop路径失败: ${error.message}`);
      }
    }

    async function selectJsxPath() {
      try {
        const path = await window.electronAPI.selectDirectory();
        if (path) {
          $id('jsxPath').value = path;
          await saveConfig();
        }
      } catch (error) {
        log(`选择JSX文件夹失败: ${error.message}`);
      }
    }

    async function selectOutputDir() {
      try {
        const path = await window.electronAPI.selectDirectory();
        if (path) {
          $id('outputDir').value = path;
          await saveConfig();
        }
      } catch (error) {
        log(`选择输出目录失败: ${error.message}`);
      }
    }

    async function selectRulesJsonPath() {
      try {
        const path = await window.electronAPI.selectFile({
          filters: [
            { name: 'JSON文件', extensions: ['json'] },
            { name: '所有文件', extensions: ['*'] }
          ]
        });
        if (path) {
          $id('rulesJsonPath').value = path;
          await saveConfig();
        }
      } catch (error) {
        log(`选择规则JSON失败: ${error.message}`);
      }
    }

    // 弹窗控制
    function openSettings() {
      const m = $id('settingsModal');
      if (m) m.setAttribute('aria-hidden', 'false');
    }

    function closeSettings() {
      const m = $id('settingsModal');
      if (m) m.setAttribute('aria-hidden', 'true');
      saveConfig();
    }

    // 自动保存绑定
    function bindAutoSave() {
      ['photoshopPath', 'jsxPath', 'inputDir', 'outputDir', 'rulesJsonPath'].forEach(k => {
        const el = $id(k);
        if (el) {
          el.addEventListener('change', saveConfig);
          el.addEventListener('blur', saveConfig);
        }
      });
    }

    // 设置日志监听
    function setupLogListener() {
      if (window.electronAPI && window.electronAPI.onLogMessage) {
        window.electronAPI.onLogMessage((message) => {
          log(message);
        });
      }
    }

    // 运行处理
    async function run() {
      if (isRunning) {
        log('处理正在进行中，请等待完成');
        return;
      }

      try {
        const config = collectConfig();
        
        // 基本验证
        if (!config.inputDir) {
          alert('请选择输入目录');
          return;
        }
        if (!config.photoshopPath) {
          alert('请选择Photoshop.exe路径');
          return;
        }
        if (!config.outputDir) {
          alert('请选择输出目录');
          return;
        }

        isRunning = true;
        setStatus('处理中...');
        clearLog();
        log('开始处理...');

        const result = await window.electronAPI.runPhotoshop(config);
        
        if (result.success) {
          setStatus('处理完成');
          log(`处理成功: ${result.message}`);
        } else {
          setStatus('处理失败');
          log(`处理失败: ${result.message}`);
        }
      } catch (error) {
        setStatus('处理异常');
        log(`处理异常: ${error.message}`);
      } finally {
        isRunning = false;
      }
    }

    // UI 辅助函数
    function setStatus(text) {
      const el = $id('status');
      if (el) el.textContent = text;
    }

    function log(text) {
      const el = $id('log');
      if (el) {
        el.textContent += text + '\n';
        el.scrollTop = el.scrollHeight;
      }
    }

    function clearLog() {
      const el = $id('log');
      if (el) el.textContent = '';
    }
  </script>
</body>
</html>
