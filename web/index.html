<!-- 该片段属于页面主体与脚本区域 -->
<body>
  <!-- 顶部导航 -->
  <header class="header">
    // ... existing code ...
  </header>

  <!-- 主内容 -->
  <main class="content">
    <section class="panel">
      <h2>输入目录</h2>
      <div class="row">
        <div>
          <label>输入目录</label>
          <input id="inputDir" type="text" placeholder="D\\:input" />
        </div>
      </div>
      <!-- 新增：代码文件夹（当输入目录不含SKU前缀时，会在这里继续查找） -->
      <div class="row">
        <div>
          <label>代码文件夹</label>
          <input id="codeDir" type="text" placeholder="D\\:code-folder" />
        </div>
      </div>
    </section>
    // ... existing code ...
  </main>

  // ... existing code ...

  <script>
    const $id = (x)=>document.getElementById(x);

    document.addEventListener('DOMContentLoaded', ()=>{
      load();
      bindAutoSave();
    });

    function load(){
      const saved = JSON.parse(localStorage.getItem('ps_config')||'{}');
      ['photoshopPath','jsxPath','inputDir','outputDir','rulesJsonPath','codeDir'].forEach(k=>{ if(saved[k]){ const el=$id(k); if(el) el.value=saved[k]; } });
      setStatus('就绪');
    }

    function collectBody(){
      return {
        photoshopPath: ($id('photoshopPath').value||'').trim(),
        jsxPath: ($id('jsxPath').value||'').trim(),
        inputDir: ($id('inputDir').value||'').trim(),
        outputDir: ($id('outputDir').value||'').trim(),
        rulesJsonPath: ($id('rulesJsonPath').value||'').trim(),
        // 新增：代码文件夹
        codeDir: ($id('codeDir').value||'').trim()
      };
    }

    function openSettings(){ const m=$id('settingsModal'); if(m) m.setAttribute('aria-hidden','false'); }
    function closeSettings(){ const m=$id('settingsModal'); if(m) m.setAttribute('aria-hidden','true'); saveLocal(); }

    function bindAutoSave(){
      ['photoshopPath','jsxPath','inputDir','outputDir','rulesJsonPath','codeDir'].forEach(k=>{
        const el=$id(k); if(el){ el.addEventListener('change', saveLocal); el.addEventListener('blur', saveLocal); }
      });
    }
    function saveLocal(){ const body=collectBody(); localStorage.setItem('ps_config', JSON.stringify(body)); }

    function run(){
      const base = window.location.origin;
      const body = collectBody();
      setStatus('处理中…');
      log('开始运行...');
      fetch(base+'/api/run',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)})
        .then(r=>r.json()).then(j=>{
          const ok = j && j.ok !== false && j.code === 0;
          setStatus(ok ? '处理完成' : '处理失败');
          log('完成, code='+(j.code==null?'N/A':j.code)+'\nSTDOUT:\n'+(j.stdout||'')+'\nSTDERR:\n'+(j.stderr||''));
        }).catch(e=>{ setStatus('运行异常'); log('运行异常 '+e); });
    }

    function setStatus(t){ const el=$id('status'); if(el) el.textContent = t; }
    function log(t){ const el = $id('log'); if(el){ el.textContent += (t+'\n'); el.scrollTop = el.scrollHeight; } }
  </script>
</body>
