<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è®¾è®¡å·¥åŠ</title>
  <style>
    /* ... (æ‚¨åŸæ¥çš„ CSS æ ·å¼ä¿æŒä¸å˜) ... */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
    .header { background: #fff; border-bottom: 1px solid #e0e0e0; padding: 0 20px; }
    .nav { display: flex; align-items: center; justify-content: space-between; height: 60px; }
    .logo { display: flex; align-items: center; gap: 10px; font-size: 18px; font-weight: 600; color: #333; }
    .logo svg { width: 28px; height: 28px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.12); display: block; }
    .nav-actions { display: flex; gap: 10px; }
    .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; transition: all 0.2s; }
    .btn.primary { background: #007AFF; color: white; }
    .btn.primary:hover { background: #0056CC; }
    .btn.secondary { background: #f0f0f0; color: #333; }
    .btn.secondary:hover { background: #e0e0e0; }
    .btn.success { background: #28a745; color: white; }
    .btn.success:hover { background: #218838; }
    .content { padding: 20px; max-width: 1200px; margin: 0 auto; height: calc(100vh - 80px); display: flex; flex-direction: column; }
    .panel { background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .panel.log-panel { flex: 1; display: flex; flex-direction: column; min-height: 0; }
    .panel h2 { margin-bottom: 15px; color: #333; font-size: 16px; }
    .row { display: flex; gap: 20px; margin-bottom: 15px; }
    .row > div { flex: 1; }
    .input-group { display: flex; gap: 8px; align-items: center; }
    .input-group input { flex: 1; }
    label { display: block; margin-bottom: 5px; font-weight: 500; color: #555; }
    input[type="text"] { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
    input[type="text"]:focus { outline: none; border-color: #007AFF; }
    
    /* â˜…â˜…â˜… æ–°å¢ï¼šä¸ºæˆ‘ä»¬çš„æ–°æ–‡æœ¬æ¡†æ·»åŠ æ ·å¼ â˜…â˜…â˜… */
    textarea { 
      width: 100%; 
      padding: 8px; 
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      font-family: 'Monaco', 'Menlo', monospace;
      resize: vertical;
      line-height: 1.4;
    }
    textarea:focus { outline: none; border-color: #007AFF; box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.2); }
    
    /* SKUå‰ç¼€é…ç½®åŒºåŸŸç‰¹æ®Šæ ·å¼ */
    .sku-config-section {
      background: linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%);
      border: 1px solid #e1e8ff;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .sku-config-section h2 {
      color: #4a5568;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .sku-config-section h2::before {
      content: "ğŸ¯";
      font-size: 18px;
    }
    .sku-help-text {
      margin-top: 8px; 
      font-size: 12px; 
      color: #666;
      background: rgba(255, 255, 255, 0.7);
      padding: 8px 12px;
      border-radius: 4px;
      border-left: 3px solid #007AFF;
    }
    
    .status { padding: 10px; background: #f8f9fa; border-radius: 4px; margin-bottom: 10px; font-weight: 500; }
    .log { background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 4px; font-family: 'Monaco', 'Menlo', monospace; font-size: 12px; flex: 1; overflow-y: auto; white-space: pre-wrap; min-height: 200px; }
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; display: flex; align-items: center; justify-content: center; }
    .modal[aria-hidden="true"] { display: none; }
    .modal-backdrop { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
    .modal-content { background: white; border-radius: 8px; padding: 0; width: 90%; max-width: 600px; position: relative; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid #e0e0e0; }
    .modal-title { font-size: 18px; font-weight: 600; }
    .modal-body { padding: 20px; max-height: 70vh; overflow-y: auto; } /* å…è®¸å¼¹çª—å†…å®¹æ»šåŠ¨ */
    .browse-btn { padding: 6px 12px; font-size: 12px; white-space: nowrap; }
  </style>
</head>
<body>
  <header class="header">
    <div class="nav">
      <div class="logo">
        <svg width="128" height="128" viewBox="0 0 128 128" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <rect x="8" y="8" width="112" height="112" rx="24" fill="#F7F3FF"/>
          <g><path d="M40 88 L88 40" stroke="#8E5BFF" stroke-width="8" stroke-linecap="round"/><g transform="translate(88,40)"><polygon points="0,-10 2,-3 10,-3 4,2 6,10 0,5 -6,10 -4,2 -10,-3 -2,-3" fill="#D7C7FF" stroke="#B48CFF" stroke-width="1.5"/></g><circle cx="72" cy="56" r="3" fill="#B48CFF" opacity="0.9"/><circle cx="82" cy="46" r="2" fill="#C8B3FF"/><circle cx="92" cy="52" r="2.5" fill="#A982FF"/><circle cx="78" cy="66" r="1.8" fill="#D6C7FF"/></g>
          <rect x="8" y="8" width="112" height="112" rx="24" stroke="#B48CFF" stroke-opacity="0.35"/>
        </svg>
        <span>è®¾è®¡å·¥åŠ</span>
      </div>
      <nav class="nav-actions">
        <button class="btn secondary" onclick="openSkuConfig()">SKUé…ç½®</button>
        <button class="btn secondary" onclick="openSettings()">è®¾ç½®</button>
        <button class="btn success" onclick="run()">å¼€å§‹å¤„ç†</button>
      </nav>
    </div>
  </header>

  <main class="content">
    <section class="panel">
      <h2>è¾“å…¥ç›®å½•</h2>
      <div class="row">
        <div>
          <label>è¾“å…¥ç›®å½•</label>
          <div class="input-group">
            <input id="inputDir" type="text" placeholder="é€‰æ‹©åŒ…å«å›¾ç‰‡æ–‡ä»¶çš„ç›®å½•" />
            <button class="btn secondary browse-btn" onclick="selectInputDir()">æµè§ˆ</button>
          </div>
        </div>
      </div>
    </section>
    <section class="panel log-panel">
      <h2>å¤„ç†è¿›åº¦ä¸æ—¥å¿—</h2>
      <div id="status" class="status">å°±ç»ª</div>
      <div id="log" class="log"></div>
    </section>
  </main>

  <div id="settingsModal" class="modal" aria-hidden="true">
    <div class="modal-backdrop" onclick="closeSettings()"></div>
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">è¿è¡Œé…ç½®</div>
        <button class="btn secondary" onclick="closeSettings()">å®Œæˆ</button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div>
            <label>Photoshop.exe è·¯å¾„</label>
            <div class="input-group">
              <input id="photoshopPath" type="text" placeholder="é€‰æ‹©Photoshop.exeæ–‡ä»¶" />
              <button class="btn secondary browse-btn" onclick="selectPhotoshopPath()">æµè§ˆ</button>
            </div>
          </div>
        </div>
        <div class="row">
          <div>
            <label>JSX è„šæœ¬è·¯å¾„ (ç‹¬ç«‹è„šæœ¬)</label>
            <div class="input-group">
              <input id="jsxPath" type="text" placeholder="é€‰æ‹©åŒ…å«JSXè„šæœ¬çš„æ–‡ä»¶å¤¹" />
              <button class="btn secondary browse-btn" onclick="selectJsxPath()">æµè§ˆ</button>
            </div>
          </div>
        </div>
        <div class="row">
          <div>
            <label>è¾“å‡ºç›®å½•</label>
            <div class="input-group">
              <input id="outputDir" type="text" placeholder="é€‰æ‹©è¾“å‡ºç›®å½•" />
              <button class="btn secondary browse-btn" onclick="selectOutputDir()">æµè§ˆ</button>
            </div>
          </div>
        </div>
        <div class="row">
          <div>
            <label>è§„åˆ™ JSONï¼ˆå¯é€‰ï¼‰</label>
            <div class="input-group">
              <input id="rulesJsonPath" type="text" placeholder="é€‰æ‹©è§„åˆ™JSONæ–‡ä»¶ï¼ˆå¯é€‰ï¼‰" />
              <button class="btn secondary browse-btn" onclick="selectRulesJsonPath()">æµè§ˆ</button>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- SKUé…ç½®å¼¹çª— -->
  <div id="skuConfigModal" class="modal" aria-hidden="true">
    <div class="modal-backdrop" onclick="closeSkuConfig()"></div>
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">SKUå‰ç¼€é…ç½®</div>
        <button class="btn secondary" onclick="closeSkuConfig()">å®Œæˆ</button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div>
            <label>æ‰¹é‡å¤„ç†SKUå‰ç¼€åˆ—è¡¨ (ä½¿ç”¨å†…ç½®è„šæœ¬)</label>
            <textarea id="targetFolderNames" placeholder="è¯·è¾“å…¥SKUå‰ç¼€åˆ—è¡¨ï¼Œç”¨é€—å·(,)åˆ†éš”ï¼Œä¾‹å¦‚: M001MT,M002MT,W013GZ...&#10;åŒ¹é…çš„å‰ç¼€å°†ä½¿ç”¨batch-template.jsxå¤„ç†&#10;æœªåŒ¹é…çš„å‰ç¼€ä¼šè‡ªåŠ¨æŸ¥æ‰¾å¯¹åº”çš„JSXæ–‡ä»¶" style="height: 200px;">M001MT,M002MT,W013GZ,W003MM,W013LS,M013MT,W013LM,W036MZ,W003MN,C013SS,C012SS,W003SS,W034MW,W011MW,W011MR,W033BM,W011MB,W013SS,W034MW,A012SS,A010MZ,W010MZ,A012MS,A013MS,A037MS,W013WZ,W058MH,M003MT,A013BZ,W034ML,W010BM,W010LZ,A013WZ,P013WZ,A050DA,A050DB,A050DC,C086MU,M013ST,A060MB,A060MC,A060ME,A050DG,A060MG,A060MA,A050CB,A050CA,A050AA,A050AB,A060MH,A060MI,P003OL,M023AT,M023BT,M024BT,M024CT,M024MT,M056MT,M109AT,M109MT,M115MT,W032BT,W032BM,W058MV,W010MM,A060MD,M029MS,W012TA,W012TB,W012TC,A013SA,W003LS,A060AC,W121MA,W121MS,A060ML</textarea>
            <div style="margin-top: 12px; padding: 12px; background: #f8f9ff; border-radius: 6px; border-left: 4px solid #007AFF;">
              <div style="font-size: 14px; color: #333; margin-bottom: 8px;"><strong>ğŸ’¡ ä½¿ç”¨è¯´æ˜</strong></div>
              <div style="font-size: 13px; color: #666; line-height: 1.5;">
                â€¢ <strong>æ··åˆåŒ¹é…ç­–ç•¥ï¼š</strong>åœ¨æ­¤è¾“å…¥çš„SKUå‰ç¼€å°†ä¼˜å…ˆä½¿ç”¨batch-template.jsxå¤„ç†<br>
                â€¢ <strong>è‡ªåŠ¨å›é€€ï¼š</strong>æœªåŒ¹é…çš„å‰ç¼€ä¼šè‡ªåŠ¨æŸ¥æ‰¾æ–‡ä»¶å¤¹å†…å¯¹åº”çš„JSXè„šæœ¬<br>
                â€¢ <strong>æ ¼å¼è¦æ±‚ï¼š</strong>å¤šä¸ªå‰ç¼€ç”¨é€—å·(,)åˆ†éš”ï¼Œæ”¯æŒæ¢è¡Œè¾“å…¥
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const $id = (x) => document.getElementById(x);
    let isRunning = false;

    // â˜…â˜…â˜… ä¿®æ”¹ç‚¹ 2: å°† 'targetFolderNames' æ·»åŠ åˆ°æ‰€æœ‰é…ç½®ç›¸å…³çš„å‡½æ•°ä¸­ â˜…â˜…â˜…
    const configKeys = ['photoshopPath', 'jsxPath', 'inputDir', 'outputDir', 'rulesJsonPath', 'targetFolderNames'];

    document.addEventListener('DOMContentLoaded', () => {
      loadConfig();
      bindAutoSave();
      setupLogListener();
    });

    // åŠ è½½é…ç½®
    async function loadConfig() {
      try {
        const config = await window.electronAPI.getConfig();
        configKeys.forEach(k => {
          if (config[k]) {
            const el = $id(k);
            if (el) el.value = config[k];
          }
        });
        setStatus('é…ç½®å·²åŠ è½½');
      } catch (error) {
        log(`åŠ è½½é…ç½®å¤±è´¥: ${error.message}`);
      }
    }

    // æ”¶é›†è¡¨å•æ•°æ®
    function collectConfig() {
      const config = {};
      configKeys.forEach(k => {
        const el = $id(k);
        if (el) config[k] = (el.value || '').trim();
      });
      return config;
    }

    // ä¿å­˜é…ç½®
    async function saveConfig() {
      try {
        const config = collectConfig();
        await window.electronAPI.saveConfig(config);
      } catch (error) {
        log(`ä¿å­˜é…ç½®å¤±è´¥: ${error.message}`);
      }
    }

    // ... (æ‰€æœ‰çš„æ–‡ä»¶/æ–‡ä»¶å¤¹é€‰æ‹©å‡½æ•°ä¿æŒä¸å˜) ...
    async function selectInputDir() { /* ... */ }
    async function selectPhotoshopPath() { /* ... */ }
    async function selectJsxPath() { /* ... */ }
    async function selectOutputDir() { /* ... */ }
    async function selectRulesJsonPath() { /* ... */ }

    // å¼¹çª—æ§åˆ¶
    function openSettings() { /* ... */ }
    function closeSettings() { /* ... */ }
    
    // (ä¸ºäº†ç®€æ´ï¼Œæœªä¿®æ”¹çš„å‡½æ•°å·²æŠ˜å )
    async function selectInputDir() { try { const path = await window.electronAPI.selectDirectory(); if (path) { $id('inputDir').value = path; await saveConfig(); } } catch (error) { log(`é€‰æ‹©è¾“å…¥ç›®å½•å¤±è´¥: ${error.message}`); } }
    async function selectPhotoshopPath() { try { const path = await window.electronAPI.selectFile({ filters: [{ name: 'Photoshop', extensions: ['exe'] }, { name: 'æ‰€æœ‰æ–‡ä»¶', extensions: ['*'] }] }); if (path) { $id('photoshopPath').value = path; await saveConfig(); } } catch (error) { log(`é€‰æ‹©Photoshopè·¯å¾„å¤±è´¥: ${error.message}`); } }
    async function selectJsxPath() { try { const path = await window.electronAPI.selectDirectory(); if (path) { $id('jsxPath').value = path; await saveConfig(); } } catch (error) { log(`é€‰æ‹©JSXæ–‡ä»¶å¤¹å¤±è´¥: ${error.message}`); } }
    async function selectOutputDir() { try { const path = await window.electronAPI.selectDirectory(); if (path) { $id('outputDir').value = path; await saveConfig(); } } catch (error) { log(`é€‰æ‹©è¾“å‡ºç›®å½•å¤±è´¥: ${error.message}`); } }
    async function selectRulesJsonPath() { try { const path = await window.electronAPI.selectFile({ filters: [{ name: 'JSONæ–‡ä»¶', extensions: ['json'] }, { name: 'æ‰€æœ‰æ–‡ä»¶', extensions: ['*'] }] }); if (path) { $id('rulesJsonPath').value = path; await saveConfig(); } } catch (error) { log(`é€‰æ‹©è§„åˆ™JSONå¤±è´¥: ${error.message}`); } }
    function openSettings() { const m = $id('settingsModal'); if (m) m.setAttribute('aria-hidden', 'false'); }
    function closeSettings() { const m = $id('settingsModal'); if (m) m.setAttribute('aria-hidden', 'true'); saveConfig(); }

    // SKUé…ç½®å¼¹çª—å‡½æ•°
    function openSkuConfig() { const m = $id('skuConfigModal'); if (m) m.setAttribute('aria-hidden', 'false'); }
    function closeSkuConfig() { const m = $id('skuConfigModal'); if (m) m.setAttribute('aria-hidden', 'true'); saveConfig(); }


    // è‡ªåŠ¨ä¿å­˜ç»‘å®š
    function bindAutoSave() {
      configKeys.forEach(k => {
        const el = $id(k);
        if (el) {
          el.addEventListener('change', saveConfig);
          el.addEventListener('blur', saveConfig);
        }
      });
    }

    // è®¾ç½®æ—¥å¿—ç›‘å¬
    function setupLogListener() {
      if (window.electronAPI && window.electronAPI.onLogMessage) {
        window.electronAPI.onLogMessage((message) => {
          log(message);
        });
      }
    }

    // è¿è¡Œå¤„ç†
    async function run() {
      if (isRunning) {
        log('å¤„ç†æ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·ç­‰å¾…å®Œæˆ');
        return;
      }

      try {
        const config = collectConfig();
        
        // åŸºæœ¬éªŒè¯
        if (!config.inputDir) { alert('è¯·é€‰æ‹©è¾“å…¥ç›®å½•'); return; }
        if (!config.photoshopPath) { alert('è¯·é€‰æ‹©Photoshop.exeè·¯å¾„'); return; }
        if (!config.outputDir) { alert('è¯·é€‰æ‹©è¾“å‡ºç›®å½•'); return; }

        isRunning = true;
        setStatus('å¤„ç†ä¸­...');
        clearLog();
        log('å¼€å§‹å¤„ç†...');

        const result = await window.electronAPI.runPhotoshop(config);
        
        if (result.success) {
          setStatus('å¤„ç†å®Œæˆ');
          log(`å¤„ç†æˆåŠŸ: ${result.message}`);
        } else {
          setStatus('å¤„ç†å¤±è´¥');
          log(`å¤„ç†å¤±è´¥: ${result.message}`);
        }
      } catch (error) {
        setStatus('å¤„ç†å¼‚å¸¸');
        log(`å¤„ç†å¼‚å¸¸: ${error.message}`);
      } finally {
        isRunning = false;
      }
    }

    // UI è¾…åŠ©å‡½æ•°
    function setStatus(text) { $id('status').textContent = text; }
    function log(text) { const el = $id('log'); el.textContent += text + '\n'; el.scrollTop = el.scrollHeight; }
    function clearLog() { $id('log').textContent = ''; }
  </script>
</body>
</html>