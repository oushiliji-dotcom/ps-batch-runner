<script>
  // ... existing code ...
  const $id = (x)=>document.getElementById(x);

  // 固定后端地址：若不是 http/https（比如从 file:// 或 Electron 打开），一律走本地服务
  const BASE = (location.protocol === 'http:' || location.protocol === 'https:')
    ? `${location.protocol}//${location.host}`
    : 'http://localhost:3017';

  // ... existing code ...

  function run(){
    const body = collectBody();
    setStatus('处理中…');
    log('开始运行...');
    // 统一用 BASE 调 /api/run，避免因 origin 变化导致 Failed to fetch
    fetch(`${BASE}/api/run`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body)
    })
      .then(r=>r.json()).then(j=>{
        const ok = j && j.ok !== false && j.code === 0;
        setStatus(ok ? '处理完成' : '处理失败');
        log('完成, code='+(j.code==null?'N/A':j.code)+'\nSTDOUT:\n'+(j.stdout||'')+'\nSTDERR:\n'+(j.stderr||''));
      })
      .catch(e=>{ setStatus('运行异常'); log('运行异常 '+e); });
  }

  // ... existing code ...
</script>
