<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>设计工坊</title>
  <style>
    /* ... (您原来的 CSS 样式保持不变) ... */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
    .header { background: #fff; border-bottom: 1px solid #e0e0e0; padding: 0 20px; }
    .nav { display: flex; align-items: center; justify-content: space-between; height: 60px; }
    .logo { display: flex; align-items: center; gap: 10px; font-size: 18px; font-weight: 600; color: #333; }
    .logo svg { width: 28px; height: 28px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.12); display: block; }
    .nav-actions { display: flex; gap: 10px; }
    .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; transition: all 0.2s; }
    .btn.primary { background: #007AFF; color: white; }
    .btn.primary:hover { background: #0056CC; }
    .btn.secondary { background: #f0f0f0; color: #333; }
    .btn.secondary:hover { background: #e0e0e0; }
    .btn.success { background: #28a745; color: white; }
    .btn.success:hover { background: #218838; }
    .content { padding: 20px; max-width: 1200px; margin: 0 auto; height: calc(100vh - 80px); display: flex; flex-direction: column; }
    .panel { background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .panel.log-panel { flex: 1; display: flex; flex-direction: column; min-height: 0; }
    .panel h2 { margin-bottom: 15px; color: #333; font-size: 16px; }
    .row { display: flex; gap: 20px; margin-bottom: 15px; }
    .row > div { flex: 1; }
    .input-group { display: flex; gap: 8px; align-items: center; }
    .input-group input { flex: 1; }
    label { display: block; margin-bottom: 5px; font-weight: 500; color: #555; }
    input[type="text"] { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
    input[type="text"]:focus { outline: none; border-color: #007AFF; }
    
    /* ★★★ 新增：为我们的新文本框添加样式 ★★★ */
    textarea { 
      width: 100%; 
      padding: 8px; 
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      font-family: 'Monaco', 'Menlo', monospace;
      resize: vertical;
      line-height: 1.4;
    }
    textarea:focus { outline: none; border-color: #007AFF; box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.2); }
    
    /* SKU前缀配置区域特殊样式 */
    .sku-config-section {
      background: linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%);
      border: 1px solid #e1e8ff;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .sku-config-section h2 {
      color: #4a5568;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .sku-config-section h2::before {
      content: "🎯";
      font-size: 18px;
    }
    .sku-help-text {
      margin-top: 8px; 
      font-size: 12px; 
      color: #666;
      background: rgba(255, 255, 255, 0.7);
      padding: 8px 12px;
      border-radius: 4px;
      border-left: 3px solid #007AFF;
    }
    
    .status { padding: 10px; background: #f8f9fa; border-radius: 4px; margin-bottom: 10px; font-weight: 500; }
    .log { background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 4px; font-family: 'Monaco', 'Menlo', monospace; font-size: 12px; flex: 1; overflow-y: auto; white-space: pre-wrap; min-height: 200px; }
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; display: flex; align-items: center; justify-content: center; }
    .modal[aria-hidden="true"] { display: none; }
    .modal-backdrop { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
    .modal-content { background: white; border-radius: 8px; padding: 0; width: 90%; max-width: 600px; position: relative; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid #e0e0e0; }
    .modal-title { font-size: 18px; font-weight: 600; }
    .modal-body { padding: 20px; max-height: 70vh; overflow-y: auto; } /* 允许弹窗内容滚动 */
    .browse-btn { padding: 6px 12px; font-size: 12px; white-space: nowrap; }
  </style>
</head>
<body>
  <header class="header">
    <div class="nav">
      <div class="logo">
        <svg width="128" height="128" viewBox="0 0 128 128" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <rect x="8" y="8" width="112" height="112" rx="24" fill="#F7F3FF"/>
          <g><path d="M40 88 L88 40" stroke="#8E5BFF" stroke-width="8" stroke-linecap="round"/><g transform="translate(88,40)"><polygon points="0,-10 2,-3 10,-3 4,2 6,10 0,5 -6,10 -4,2 -10,-3 -2,-3" fill="#D7C7FF" stroke="#B48CFF" stroke-width="1.5"/></g><circle cx="72" cy="56" r="3" fill="#B48CFF" opacity="0.9"/><circle cx="82" cy="46" r="2" fill="#C8B3FF"/><circle cx="92" cy="52" r="2.5" fill="#A982FF"/><circle cx="78" cy="66" r="1.8" fill="#D6C7FF"/></g>
          <rect x="8" y="8" width="112" height="112" rx="24" stroke="#B48CFF" stroke-opacity="0.35"/>
        </svg>
        <span>设计工坊</span>
      </div>
      <nav class="nav-actions">
        <button class="btn secondary" onclick="openSkuConfig()">SKU配置</button>
        <button class="btn secondary" onclick="openSettings()">设置</button>
        <button class="btn success" onclick="run()">开始处理</button>
      </nav>
    </div>
  </header>

  <main class="content">
    <section class="panel">
      <h2>输入目录</h2>
      <div class="row">
        <div>
          <label>输入目录</label>
          <div class="input-group">
            <input id="inputDir" type="text" placeholder="选择包含图片文件的目录" />
            <button class="btn secondary browse-btn" onclick="selectInputDir()">浏览</button>
          </div>
        </div>
      </div>
    </section>
    <section class="panel log-panel">
      <h2>处理进度与日志</h2>
      <div id="status" class="status">就绪</div>
      <div id="log" class="log"></div>
    </section>
  </main>

  <div id="settingsModal" class="modal" aria-hidden="true">
    <div class="modal-backdrop" onclick="closeSettings()"></div>
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">运行配置</div>
        <button class="btn secondary" onclick="closeSettings()">完成</button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div>
            <label>Photoshop.exe 路径</label>
            <div class="input-group">
              <input id="photoshopPath" type="text" placeholder="选择Photoshop.exe文件" />
              <button class="btn secondary browse-btn" onclick="selectPhotoshopPath()">浏览</button>
            </div>
          </div>
        </div>
        <div class="row">
          <div>
            <label>JSX 脚本路径 (独立脚本)</label>
            <div class="input-group">
              <input id="jsxPath" type="text" placeholder="选择包含JSX脚本的文件夹" />
              <button class="btn secondary browse-btn" onclick="selectJsxPath()">浏览</button>
            </div>
          </div>
        </div>
        <div class="row">
          <div>
            <label>输出目录</label>
            <div class="input-group">
              <input id="outputDir" type="text" placeholder="选择输出目录" />
              <button class="btn secondary browse-btn" onclick="selectOutputDir()">浏览</button>
            </div>
          </div>
        </div>
        <div class="row">
          <div>
            <label>规则 JSON（可选）</label>
            <div class="input-group">
              <input id="rulesJsonPath" type="text" placeholder="选择规则JSON文件（可选）" />
              <button class="btn secondary browse-btn" onclick="selectRulesJsonPath()">浏览</button>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- SKU配置弹窗 -->
  <div id="skuConfigModal" class="modal" aria-hidden="true">
    <div class="modal-backdrop" onclick="closeSkuConfig()"></div>
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">SKU前缀配置</div>
        <button class="btn secondary" onclick="closeSkuConfig()">完成</button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div>
            <label>批量处理SKU前缀列表 (使用内置脚本)</label>
            <textarea id="targetFolderNames" placeholder="请输入SKU前缀列表，用逗号(,)分隔，例如: M001MT,M002MT,W013GZ...&#10;匹配的前缀将使用batch-template.jsx处理&#10;未匹配的前缀会自动查找对应的JSX文件" style="height: 200px;">M001MT,M002MT,W013GZ,W003MM,W013LS,M013MT,W013LM,W036MZ,W003MN,C013SS,C012SS,W003SS,W034MW,W011MW,W011MR,W033BM,W011MB,W013SS,W034MW,A012SS,A010MZ,W010MZ,A012MS,A013MS,A037MS,W013WZ,W058MH,M003MT,A013BZ,W034ML,W010BM,W010LZ,A013WZ,P013WZ,A050DA,A050DB,A050DC,C086MU,M013ST,A060MB,A060MC,A060ME,A050DG,A060MG,A060MA,A050CB,A050CA,A050AA,A050AB,A060MH,A060MI,P003OL,M023AT,M023BT,M024BT,M024CT,M024MT,M056MT,M109AT,M109MT,M115MT,W032BT,W032BM,W058MV,W010MM,A060MD,M029MS,W012TA,W012TB,W012TC,A013SA,W003LS,A060AC,W121MA,W121MS,A060ML</textarea>
            <div style="margin-top: 12px; padding: 12px; background: #f8f9ff; border-radius: 6px; border-left: 4px solid #007AFF;">
              <div style="font-size: 14px; color: #333; margin-bottom: 8px;"><strong>💡 使用说明</strong></div>
              <div style="font-size: 13px; color: #666; line-height: 1.5;">
                • <strong>混合匹配策略：</strong>在此输入的SKU前缀将优先使用batch-template.jsx处理<br>
                • <strong>自动回退：</strong>未匹配的前缀会自动查找文件夹内对应的JSX脚本<br>
                • <strong>格式要求：</strong>多个前缀用逗号(,)分隔，支持换行输入
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const $id = (x) => document.getElementById(x);
    let isRunning = false;

    // ★★★ 修改点 2: 将 'targetFolderNames' 添加到所有配置相关的函数中 ★★★
    const configKeys = ['photoshopPath', 'jsxPath', 'inputDir', 'outputDir', 'rulesJsonPath', 'targetFolderNames'];

    document.addEventListener('DOMContentLoaded', () => {
      loadConfig();
      bindAutoSave();
      setupLogListener();
    });

    // 加载配置
    async function loadConfig() {
      try {
        const config = await window.electronAPI.getConfig();
        configKeys.forEach(k => {
          if (config[k]) {
            const el = $id(k);
            if (el) el.value = config[k];
          }
        });
        setStatus('配置已加载');
      } catch (error) {
        log(`加载配置失败: ${error.message}`);
      }
    }

    // 收集表单数据
    function collectConfig() {
      const config = {};
      configKeys.forEach(k => {
        const el = $id(k);
        if (el) config[k] = (el.value || '').trim();
      });
      return config;
    }

    // 保存配置
    async function saveConfig() {
      try {
        const config = collectConfig();
        await window.electronAPI.saveConfig(config);
      } catch (error) {
        log(`保存配置失败: ${error.message}`);
      }
    }

    // ... (所有的文件/文件夹选择函数保持不变) ...
    async function selectInputDir() { /* ... */ }
    async function selectPhotoshopPath() { /* ... */ }
    async function selectJsxPath() { /* ... */ }
    async function selectOutputDir() { /* ... */ }
    async function selectRulesJsonPath() { /* ... */ }

    // 弹窗控制
    function openSettings() { /* ... */ }
    function closeSettings() { /* ... */ }
    
    // (为了简洁，未修改的函数已折叠)
    async function selectInputDir() { try { const path = await window.electronAPI.selectDirectory(); if (path) { $id('inputDir').value = path; await saveConfig(); } } catch (error) { log(`选择输入目录失败: ${error.message}`); } }
    async function selectPhotoshopPath() { try { const path = await window.electronAPI.selectFile({ filters: [{ name: 'Photoshop', extensions: ['exe'] }, { name: '所有文件', extensions: ['*'] }] }); if (path) { $id('photoshopPath').value = path; await saveConfig(); } } catch (error) { log(`选择Photoshop路径失败: ${error.message}`); } }
    async function selectJsxPath() { try { const path = await window.electronAPI.selectDirectory(); if (path) { $id('jsxPath').value = path; await saveConfig(); } } catch (error) { log(`选择JSX文件夹失败: ${error.message}`); } }
    async function selectOutputDir() { try { const path = await window.electronAPI.selectDirectory(); if (path) { $id('outputDir').value = path; await saveConfig(); } } catch (error) { log(`选择输出目录失败: ${error.message}`); } }
    async function selectRulesJsonPath() { try { const path = await window.electronAPI.selectFile({ filters: [{ name: 'JSON文件', extensions: ['json'] }, { name: '所有文件', extensions: ['*'] }] }); if (path) { $id('rulesJsonPath').value = path; await saveConfig(); } } catch (error) { log(`选择规则JSON失败: ${error.message}`); } }
    function openSettings() { const m = $id('settingsModal'); if (m) m.setAttribute('aria-hidden', 'false'); }
    function closeSettings() { const m = $id('settingsModal'); if (m) m.setAttribute('aria-hidden', 'true'); saveConfig(); }

    // SKU配置弹窗函数
    function openSkuConfig() { const m = $id('skuConfigModal'); if (m) m.setAttribute('aria-hidden', 'false'); }
    function closeSkuConfig() { const m = $id('skuConfigModal'); if (m) m.setAttribute('aria-hidden', 'true'); saveConfig(); }


    // 自动保存绑定
    function bindAutoSave() {
      configKeys.forEach(k => {
        const el = $id(k);
        if (el) {
          el.addEventListener('change', saveConfig);
          el.addEventListener('blur', saveConfig);
        }
      });
    }

    // 设置日志监听
    function setupLogListener() {
      if (window.electronAPI && window.electronAPI.onLogMessage) {
        window.electronAPI.onLogMessage((message) => {
          log(message);
        });
      }
    }

    // 运行处理
    async function run() {
      if (isRunning) {
        log('处理正在进行中，请等待完成');
        return;
      }

      try {
        const config = collectConfig();
        
        // 基本验证
        if (!config.inputDir) { alert('请选择输入目录'); return; }
        if (!config.photoshopPath) { alert('请选择Photoshop.exe路径'); return; }
        if (!config.outputDir) { alert('请选择输出目录'); return; }

        isRunning = true;
        setStatus('处理中...');
        clearLog();
        log('开始处理...');

        const result = await window.electronAPI.runPhotoshop(config);
        
        if (result.success) {
          setStatus('处理完成');
          log(`处理成功: ${result.message}`);
        } else {
          setStatus('处理失败');
          log(`处理失败: ${result.message}`);
        }
      } catch (error) {
        setStatus('处理异常');
        log(`处理异常: ${error.message}`);
      } finally {
        isRunning = false;
      }
    }

    // UI 辅助函数
    function setStatus(text) { $id('status').textContent = text; }
    function log(text) { const el = $id('log'); el.textContent += text + '\n'; el.scrollTop = el.scrollHeight; }
    function clearLog() { $id('log').textContent = ''; }
  </script>
</body>
</html>